---
title: IPv4
description: Internet Protocol Version 4
---

import { Steps } from '@astrojs/starlight/components';
import { Tabs, TabItem } from '@astrojs/starlight/components';

IP (Internet Protocol) is a common protocol used in the TCP/IP suit. All applications that need to communicate over the internet will use IP to encapsulate the application data. It is a best effort protocol because it does not guarantee the delivery of the data. It is a connectionless protocol because it does not establish a connection before sending the data. Instead it will rely on the transport layer to establish a connection if needed.

## IP Header

The following are in the fields in the IP header:
```
0               1               2               3               4
0 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8 1 2 3 4 5 6 7 8
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Options (variable lenght)            |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Data (variable lenght)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```
- **Options** (variable length, up to 40 bytes): Optional fields for additional information.
- **Data** (variable length): The actual data being transmitted.

### Version (4 bits)
The version field is used to identify the version of the IP protocol being used. The most common versions are IPv4 and IPv6.

### IHL (Internet Header Length) (4 bits)
The IHL field is used to specify the length of the IP header. 

The importance of this filed is to know where the data starts since the header can be variable length due to the options field.

### Type of Service (8 bits)
The Type of Service (ToS) field is used to specify the quality of service for the IP packet. It is divided into two parts: the Differentiated Services Field (DSF) and the Explicit Congestion Notification (ECN).

The DSF part is used by routers to determine how to prioritize the packets that traverse the network. The ECN part is used by the sender and receiver to indicate congestion in the network.

### Total Length (16 bits)

The Total Length field is used to specify the total length of the IP packet, including the header and data. 

This field is usefull to know where the data ends, and this requires the IHL field to know where the data starts.

### Identification (16 bits)

This is a unique identifier for the IP packet done by the host that is sending the packet. This field is used to identify the fragments of the same IP packet when they are sent over the network which will have the same identification number.

### Flags (3 bits)

By seting each of the 3 bits to 1 or 0 we can get the following infromation from this filed:
- 000: Reserved, it is always set to 0.
- 010: Don't Fragment (DF) flag is set, which means that the packet should not be fragmented.
- 001: More Fragments (MF) flag is set, which means that there are more fragments to come. 

### Fragment Offset (13 bits)

This field is used to specify up to which byte of the original IP packet the new fragment starts. This field is used to reassemble the original IP packet at the destination host.

The fragment offset of the first fragment is always set to 0. The fragment offset of the second fragment is set to the size of the first fragment, and so on.

### TTL (Time to Live) (8 bits)
The TTL field is used to specify the maximum number of hops that the IP packet can take before it is discarded. This field is used to prevent the IP packet from circulating indefinitely in the network.

The TTL field is decremented by 1 at each hop. If the TTL field reaches 0, the IP packet is discarded and an ICMP Time Exceeded message is sent back to the sender.

### Protocol (8 bits)

The Protocol field is used to specify the protocol used in the transport layer. This is used by the receiver to determine how to process the data in the IP packet. Also that can be used by firewalls to filter the packets based on the protocol used.

The following are some of the most common protocols:
- **TCP (6)**: Transmission Control Protocol
- **UDP (17)**: User Datagram Protocol
- **ICMP (1)**: Internet Control Message Protocol
- **IGMP (2)**: Internet Group Management Protocol
- **GRE (47)**: Generic Routing Encapsulation
- **ESP (50)**: Encapsulating Security Payload
- **AH (51)**: Authentication Header
- **OSPF (89)**: Open Shortest Path First

### Header Checksum (16 bits)
The Header Checksum field is used to verify the integrity of the IP header.

When the IP packet is received, the receiver calculates the checksum again and compares it with the value in the Header Checksum field. If they do not match, it means that the IP header has been corrupted and the packet is discarded.

Steps to calculate the checksum for the IP header example `45 00 00 3c 1c 46 40 00 40 06 b1 e6 c0 a8 00 68 c0 a8 00 01` (cibsiudering a simple header without options):

<Steps>

1. **Set the Checksum Field to Zero**: Before calculating the checksum, set the checksum field in the header to zero.

2. **Divide the Header into 16-bit Words**: The IP header is divided into 16-bit words. If the header length is not a multiple of 16 bits, it is padded with zeros.

    In our example, the header is divided into the following 16-bit words:
    ```
    4500 003c 1c46 4000 4006 b1e6 c0a8 0068 c0a8 0001
    ```
3. **Sum the 16-bit Words**: Add all the 16-bit words together. If the sum exceeds 16 bits, the overflow is added back to the sum.

    In our example to make it easier to read we will convert the hex values to decimal:

    | Hexadecimal | Decimal |
    |-------------|---------|
    | 4500        | 17664   |
    | 003c        | 60      |
    | 1c46        | 7238    |
    | 4000        | 16384   |
    | 4006        | 16390   |
    | b1e6        | 45542   |
    | c0a8        | 49320   |
    | 0068        | 104     |
    | c0a8        | 49320   |
    | 0001        | 1       |
    | **Sum**     | **202023**  |

    Then ther sum is: 202023 which is 31527 in HEX so we need handle the overflow which in this case is `3`

4. **Add the Overflow**: If the sum exceeds 16 bits, add the overflow back to the sum. 

    Now we have the following 2 numbers to sum:
    | Hexadecimal | Decimal |
    |-------------|---------|
    | 1527        | 5479    |
    | 3           | 3       |
    | **Sum**     | **1530**  |

    The sum is 1530 which is 0x152A in hex and this is 16 bits so we can move to next step

5. **Convert the Sum to One's Complement**: The checksum is the one's complement of the sum. 

    To calculate the one's complement, we need to invert all the bits in the sum. Lets convert the sum to binary so it is easier to cisualize it:
    | Hexadecimal | Decimal | Binary          |
    |-------------|---------|-----------------|
    | 0x152A        | 1530    | 0001010100101010 |

    The `One's Complement` is done by inverting all the bits, so then the checksum is:
    | Hexadecimal | Decimal | Binary      |
    |-----------------|-------------|-----------------|
    | **0xEAD5**       | 60533   | 1110101011010101 |

</Steps>

### Source Address (32 bits)
The Source Address field is used to specify the IP address of the sender. This field is used by the receiver to determine where the IP packet came from so then it can send the response back to the sender.

:::note
This filed can be change while in transit if used NAT (Network Address Translation).
:::
### Destination Address (32 bits)
The Destination Address field is used to specify the IP address of the receiver. This field is used by the routers to determine where to send the IP packet.
:::note
Different than the source address, this field should not be changed while in transit.
:::
### Options (variable length)

This options are not commonly used, but they can be used to specify additional information about the IP packet which is considered a security risk.

### Padding (variable length)
The Padding field is used to ensure that the IP header is a multiple of 32 bits then this is needed when the options field is used. The padding is done by adding zeros to the end of the header.

## IP fragmentation

IP fragmentation is the process of breaking down an IP packet into smaller fragments to fit into the maximum transmission unit (MTU) of the network. This is done when the IP packet is too large to be transmitted over the network.

### IP Fragmentation drawbacks

- **Increased overhead**: Fragmentation adds overhead to the IP packet, which can reduce the overall performance of the network. Each fragment has its own header, which increases the size of the packet.
- **Increased latency**: Fragmentation can increase the latency of the network, as each fragment must be transmitted separately and reassembled at the destination. This can cause delays in the delivery of the IP packet.
- **Increased complexity**: Fragmentation can increase the complexity of the network, as it requires additional processing to reassemble the fragments at the destination. This can increase the load on the routers and switches in the network.
- **Increased risk of packet loss**: Fragmentation can increase the risk of packet loss, as each fragment must be transmitted separately. If one fragment is lost, the entire IP packet must be retransmitted, which can cause delays in the delivery of the data.
- **Loos of TCP/UDP headers**: If the IP packet is fragmented, the TCP or UDP headers will be present on the first fragment only and if the is filtering based on it it will be working only for the first fragment. 
- **Different paths when ECMP**: Since the Application layer header will not be present on most of the fragments then the load balancing algorithms used by the routers will not be able to use the same path for all the fragments.

### IP Fragmentation process

The following is a step by step about how the IP fragmentation works
<Steps>
1. **Packet creation**: 

    The sender creates an IP packet with a size which has a size larger that the MTU on a interface of the path to the destination. For example, the MTU is 1500 bytes and the IP packet is 2000 bytes.

    :::note
    The sender will set the DF (Don't Fragment) flag to 0, which means that the packet can be fragmented.
    :::

2. **Fragmentation decision**: 

    The packets is send to the network and a router in the path with a MTU smaller than the size of the packet will see that the DF flag is set to 0 and will start the fragmentation process. 

3. **Fragmentation process (first fragment)**: 

    The router will break the data from the original IP packet into smaller fragments that fit into the MTU of the interface and it will do the folowing to the header of the first fragment:
    - Set the Identification field to the same value as the original IP packet.
    - Set the Flags field to 001 to signal that there are more fragments to come. 
    - Set the Fragment Offset field to 0, since this is the first fragment.

4. **Fragmentation process (subsequent fragments)**:
    The difference with the first fragment is that the router will set the Fragment Offset field to the size of the previous fragment

5. **Fragmentation process (last fragment)**:
    The router will set the Flags field to 000 to signal that this is the last fragment. The Fragment Offset field will be set to the size of the previous fragment.

6. **Fragment transmission**:
    The router will transmit the fragments to the next hop in the network. Each fragment will be transmitted separately and will have its own IP header.

    :::note
    If in the next hop the MTU is smaller that the fragment size then the router will repeat the fragmentation process.
    :::
7. **Fragment reassembly**:
    The destination host will receive the fragments and will reassemble them into the original IP packet. The reassembly process is done by using the Identification field to identify the fragments that belong to the same IP packet and the Fragment Offset field to determine the order of the fragments.


</Steps>

:::note
The fragmentation process is done by the routers in the path to the destination. The sender and receiver do not need to be aware of the fragmentation process.
:::

### Fragmentation example
#### Lab setup

We will test this with the following topology 
```yml
name: ip_fragmentation
mgmt:
  network: mgmt
  ipv4-subnet: 10.0.0.0/24
topology:
  nodes:
    r1:
      kind: ceos
      image: ceos:4.32.2F
      mgmt-ipv4: 10.0.0.2
    r2:
      kind: ceos
      image: ceos:4.32.2F
      mgmt-ipv4: 10.0.0.3
    r3:
      kind: ceos
      image: ceos:4.32.2F
      mgmt-ipv4: 10.0.0.4
  links:
    - endpoints: ["r1:eth1", "r2:eth1"]
    - endpoints: ["r2:eth2", "r3:eth2"]
```
Where we will need to add the follwing config to the r1 node:
<Tabs>
  <TabItem label="r1">
    ```bash
    enable
    configure
    ip routing
    ip route 10.0.2.0/24 10.0.1.1
    interface eth1
      no switchport
      ip address 10.0.1.2/24
    ```
  </TabItem>
  <TabItem label="r2">
    ```bash 
    enable
    configure
    ip routing
    interface eth1
      no switchport
      ip address 10.0.1.1/24
    interface eth2
      no switchport
      ip address 10.0.2.1/24
    ```
  </TabItem>
  <TabItem label="r3">
    ```bash
    enable
    configure
    ip routing
    ip route 10.0.1.0/24 10.0.2.1
    interface eth2
      no switchport
      ip address 10.0.2.2/24
    ```
  </TabItem>
</Tabs>
So then we have the following interfaces 
```bash
r2#show ip int br
                                                                           Address
Interface         IP Address        Status       Protocol           MTU    Owner
----------------- ----------------- ------------ -------------- ---------- -------
Ethernet1         10.0.1.1/24       up           up                1500
Ethernet2         10.0.2.1/24       up           up                1500
Management0       10.0.0.3/24       up           up                1500
```
Where we are learning the arp from the 2 hosts
```bash
r2#show ip arp
Address         Age (sec)  Hardware Addr   Interface
10.0.1.2          0:02:30  aac1.ab8b.703a  Ethernet1
10.0.2.2          0:02:34  aac1.ab70.33d4  Ethernet2
10.0.0.1          0:00:00  0242.eac2.81c1  Management0
```
#### MTU status
The following is the IP MTU on the router's interfaces
<Tabs>
  <TabItem label="r1">
    ```bash title="r1 IP MTU"
    r1#show interfaces ethernet 1 | include MTU
      IP MTU 1500 bytes (default), BW 1000000 kbit
    ```
  </TabItem>
  <TabItem label="r2">
    ```bash title="r2 IP MTU"
    r2#show interfaces ethernet 1-2 | include MTU
      IP MTU 1500 bytes, BW 1000000 kbit
      IP MTU 1500 bytes, BW 1000000 kbit
    ```
  </TabItem>
  <TabItem label="r3">
    ```bash title="r3 IP MTU"
    r3#show interfaces ethernet 2 | include MTU
      IP MTU 1500 bytes (default), BW 1000000 kbit
    ```
  </TabItem>
</Tabs>
#### Test with no need for fragmentation
Since the lower MTU in the path is 1500, doing the following ping with a size of 400 the we do not see a need for fragmentation
<Tabs>
  <TabItem label="Ping from r1">
    ```bash title="Ping from r1 to r3"
    r1#ping 10.0.2.2 repeat 2
    PING 10.0.2.2 (10.0.2.2) 72(100) bytes of data.
    80 bytes from 10.0.2.2: icmp_seq=1 ttl=63 time=0.625 ms
    80 bytes from 10.0.2.2: icmp_seq=2 ttl=63 time=0.273 ms

    --- 10.0.2.2 ping statistics ---
    2 packets transmitted, 2 received, 0% packet loss, time 1ms
    rtt min/avg/max/mdev = 0.273/0.449/0.625/0.176 ms, ipg/ewma 1.001/0.581 ms
    ```
  </TabItem>
  <TabItem label="Capture on r2">
    ```bash title="Request and reply seen on r2"
    r2#tcpdump verbose interface ethernet 1 filter icmp
    tcpdump: listening on eth1, link-type EN10MB (Ethernet), snapshot length 262144 bytes
    22:56:28.360467 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 64, id 2537, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 13, seq 1, length 80
    22:56:28.361046 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 63, id 42203, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 13, seq 1, length 80
    22:56:28.361447 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 64, id 2538, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 13, seq 2, length 80
    22:56:28.361662 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 63, id 42204, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 13, seq 2, length 80
    ```
  </TabItem>
  <TabItem label="Capture on r3">
    ```bash title="Request and reply seen on r3"
    r3#tcpdump verbose interface ethernet 2 filter icmp
    tcpdump: listening on eth2, link-type EN10MB (Ethernet), snapshot length 262144 bytes
    22:56:28.360892 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 63, id 2537, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 13, seq 1, length 80
    22:56:28.360930 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 64, id 42203, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 13, seq 1, length 80
    22:56:28.361565 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 63, id 2538, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 13, seq 2, length 80
    22:56:28.361579 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 114: (tos 0x0, ttl 64, id 42204, offset 0, flags [none], proto ICMP (1), length 100)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 13, seq 2, length 80
    ```
  </TabItem>
</Tabs>
:::note
As we can see the packets are not fragmented and the size of the packets is 80 bytes which is the default size for the ping command.
:::
#### Test with fragmentation
Now we will do the same test but with a size of 2000 bytes which is larger than the MTU of the path (1500 bytes) so we will see the fragmentation process in action.

<Tabs>
  <TabItem label="Ping from r1">
    ```bash title="Ping from r1"
    r1#ping 10.0.2.2 size 2000 repeat 2
    PING 10.0.2.2 (10.0.2.2) 1972(2000) bytes of data.
    1980 bytes from 10.0.2.2: icmp_seq=1 ttl=63 time=0.813 ms
    1980 bytes from 10.0.2.2: icmp_seq=2 ttl=63 time=0.450 ms

    --- 10.0.2.2 ping statistics ---
    2 packets transmitted, 2 received, 0% packet loss, time 1ms
    rtt min/avg/max/mdev = 0.450/0.631/0.813/0.181 ms, ipg/ewma 1.001/0.767 ms
    ```
  </TabItem>
  <TabItem label="Capture on r2">
    ```bash title="Capture on r2 with fragmentation"
    r2#tcpdump verbose interface ethernet 1 filter icmp
    tcpdump: listening on eth1, link-type EN10MB (Ethernet), snapshot length 262144 bytes
    22:57:58.471775 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 64, id 13867, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 14, seq 1, length 1480
    22:57:58.471790 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 64, id 13867, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.1.2 > 10.0.2.2: ip-proto-1
    22:57:58.472467 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 63, id 25350, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 14, seq 1, length 1480
    22:57:58.472550 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 63, id 25350, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.2.2 > 10.0.1.2: ip-proto-1
    22:57:58.472759 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 64, id 13868, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 14, seq 2, length 1480
    22:57:58.472765 aa:c1:ab:28:a6:bd > aa:c1:ab:35:ed:79, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 64, id 13868, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.1.2 > 10.0.2.2: ip-proto-1
    22:57:58.473091 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 63, id 25351, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 14, seq 2, length 1480
    22:57:58.473187 aa:c1:ab:35:ed:79 > aa:c1:ab:28:a6:bd, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 63, id 25351, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.2.2 > 10.0.1.2: ip-proto-1
    ```
  </TabItem>
  <TabItem label="Capture on r3">
    ```bash title="Capture on r3 with fragmentation"
    r3#tcpdump verbose interface ethernet 2 filter icmp
    tcpdump: listening on eth2, link-type EN10MB (Ethernet), snapshot length 262144 bytes
    22:57:58.472210 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 63, id 13867, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 14, seq 1, length 1480
    22:57:58.472331 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 63, id 13867, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.1.2 > 10.0.2.2: ip-proto-1
    22:57:58.472363 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 64, id 25350, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 14, seq 1, length 1480
    22:57:58.472366 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 64, id 25350, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.2.2 > 10.0.1.2: ip-proto-1
    22:57:58.472893 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 63, id 13868, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.1.2 > 10.0.2.2: ICMP echo request, id 14, seq 2, length 1480
    22:57:58.472990 aa:c1:ab:75:ba:fa > aa:c1:ab:7d:bb:26, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 63, id 13868, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.1.2 > 10.0.2.2: ip-proto-1
    22:57:58.473005 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 1514: (tos 0x0, ttl 64, id 25351, offset 0, flags [+], proto ICMP (1), length 1500)
        10.0.2.2 > 10.0.1.2: ICMP echo reply, id 14, seq 2, length 1480
    22:57:58.473007 aa:c1:ab:7d:bb:26 > aa:c1:ab:75:ba:fa, ethertype IPv4 (0x0800), length 534: (tos 0x0, ttl 64, id 25351, offset 1480, flags [none], proto ICMP (1), length 520)
        10.0.2.2 > 10.0.1.2: ip-proto-1
    ```
  </TabItem>
  <TabItem label="Tshark on r3">
    ```bash title="Capture detail on r3"
    richo@richo-HCAR5000-MI:~$ sudo ip netns exec clab-ip_fragmentation-r3 tshark -i eth2 -Y ip -V
    Running as user "root" and group "root". This could be dangerous.
    Capturing on 'eth2'
    ** (tshark:16175) 16:11:00.440048 [Main MESSAGE] -- Capture started.
    ** (tshark:16175) 16:11:00.440185 [Main MESSAGE] -- File: "/tmp/wireshark_eth2D7WC62.pcapng"
    Frame 2: 1514 bytes on wire (12112 bits), 1514 bytes captured (12112 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.547224990 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.547224990 seconds
        [Time delta from previous captured frame: 3.328295430 seconds]
        [Time delta from previous displayed frame: 0.000000000 seconds]
        [Time since reference or first frame: 3.328295430 seconds]
        Frame Number: 2
        Frame Length: 1514 bytes (12112 bits)
        Capture Length: 1514 bytes (12112 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:data]
    Ethernet II, Src: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa), Dst: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
        Destination: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 1500
        Identification: 0x3586 (13702)
        Flags: 0x20, More fragments
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..1. .... = More fragments: Set
        ...0 0000 0000 0000 = Fragment Offset: 0
        Time to Live: 63
        Protocol: ICMP (1)
        Header Checksum: 0x0998 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.1.2
        Destination Address: 10.0.2.2
    Data (1480 bytes)

    Frame 3: 534 bytes on wire (4272 bits), 534 bytes captured (4272 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.547352848 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.547352848 seconds
        [Time delta from previous captured frame: 0.000127858 seconds]
        [Time delta from previous displayed frame: 0.000127858 seconds]
        [Time since reference or first frame: 3.328423288 seconds]
        Frame Number: 3
        Frame Length: 534 bytes (4272 bits)
        Capture Length: 534 bytes (4272 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:icmp:data]
    Ethernet II, Src: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa), Dst: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
        Destination: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 520
        Identification: 0x3586 (13702)
        Flags: 0x00
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..0. .... = More fragments: Not set
        ...0 0101 1100 1000 = Fragment Offset: 1480
        Time to Live: 63
        Protocol: ICMP (1)
        Header Checksum: 0x2cb3 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.1.2
        Destination Address: 10.0.2.2
        [2 IPv4 Fragments (1980 bytes): #2(1480), #3(500)]
            [Frame: 2, payload: 0-1479 (1480 bytes)]
            [Frame: 3, payload: 1480-1979 (500 bytes)]
            [Fragment count: 2]
            [Reassembled IPv4 length: 1980]
            [Reassembled IPv4 data: 080005a5001300018845196800000000d557080000000000101112131415161718191a1b…]
    Internet Control Message Protocol
        Type: 8 (Echo (ping) request)
        Code: 0
        Checksum: 0x05a5 [correct]
        [Checksum Status: Good]
        Identifier (BE): 19 (0x0013)
        Identifier (LE): 4864 (0x1300)
        Sequence Number (BE): 1 (0x0001)
        Sequence Number (LE): 256 (0x0100)
        Timestamp from icmp data: May  5, 2025 16:11:04.000000000 PDT
        [Timestamp from icmp data (relative): 0.547352848 seconds]
        Data (1964 bytes)

    Frame 4: 1514 bytes on wire (12112 bits), 1514 bytes captured (12112 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.547384011 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.547384011 seconds
        [Time delta from previous captured frame: 0.000031163 seconds]
        [Time delta from previous displayed frame: 0.000031163 seconds]
        [Time since reference or first frame: 3.328454451 seconds]
        Frame Number: 4
        Frame Length: 1514 bytes (12112 bits)
        Capture Length: 1514 bytes (12112 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:data]
    Ethernet II, Src: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26), Dst: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
        Destination: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.2.2, Dst: 10.0.1.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 1500
        Identification: 0xfb35 (64309)
        Flags: 0x20, More fragments
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..1. .... = More fragments: Set
        ...0 0000 0000 0000 = Fragment Offset: 0
        Time to Live: 64
        Protocol: ICMP (1)
        Header Checksum: 0x42e8 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.2.2
        Destination Address: 10.0.1.2
    Data (1480 bytes)

    Frame 5: 534 bytes on wire (4272 bits), 534 bytes captured (4272 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.547387097 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.547387097 seconds
        [Time delta from previous captured frame: 0.000003086 seconds]
        [Time delta from previous displayed frame: 0.000003086 seconds]
        [Time since reference or first frame: 3.328457537 seconds]
        Frame Number: 5
        Frame Length: 534 bytes (4272 bits)
        Capture Length: 534 bytes (4272 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:icmp:data]
    Ethernet II, Src: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26), Dst: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
        Destination: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.2.2, Dst: 10.0.1.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 520
        Identification: 0xfb35 (64309)
        Flags: 0x00
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..0. .... = More fragments: Not set
        ...0 0101 1100 1000 = Fragment Offset: 1480
        Time to Live: 64
        Protocol: ICMP (1)
        Header Checksum: 0x6603 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.2.2
        Destination Address: 10.0.1.2
        [2 IPv4 Fragments (1980 bytes): #4(1480), #5(500)]
            [Frame: 4, payload: 0-1479 (1480 bytes)]
            [Frame: 5, payload: 1480-1979 (500 bytes)]
            [Fragment count: 2]
            [Reassembled IPv4 length: 1980]
            [Reassembled IPv4 data: 00000da5001300018845196800000000d557080000000000101112131415161718191a1b…]
    Internet Control Message Protocol
        Type: 0 (Echo (ping) reply)
        Code: 0
        Checksum: 0x0da5 [correct]
        [Checksum Status: Good]
        Identifier (BE): 19 (0x0013)
        Identifier (LE): 4864 (0x1300)
        Sequence Number (BE): 1 (0x0001)
        Sequence Number (LE): 256 (0x0100)
        [Request frame: 3]
        [Response time: 0.034 ms]
        Timestamp from icmp data: May  5, 2025 16:11:04.000000000 PDT
        [Timestamp from icmp data (relative): 0.547387097 seconds]
        Data (1964 bytes)

    Frame 6: 1514 bytes on wire (12112 bits), 1514 bytes captured (12112 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.547933732 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.547933732 seconds
        [Time delta from previous captured frame: 0.000546635 seconds]
        [Time delta from previous displayed frame: 0.000546635 seconds]
        [Time since reference or first frame: 3.329004172 seconds]
        Frame Number: 6
        Frame Length: 1514 bytes (12112 bits)
        Capture Length: 1514 bytes (12112 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:data]
    Ethernet II, Src: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa), Dst: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
        Destination: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 1500
        Identification: 0x3587 (13703)
        Flags: 0x20, More fragments
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..1. .... = More fragments: Set
        ...0 0000 0000 0000 = Fragment Offset: 0
        Time to Live: 63
        Protocol: ICMP (1)
        Header Checksum: 0x0997 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.1.2
        Destination Address: 10.0.2.2
    Data (1480 bytes)

    Frame 7: 534 bytes on wire (4272 bits), 534 bytes captured (4272 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.548036770 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.548036770 seconds
        [Time delta from previous captured frame: 0.000103038 seconds]
        [Time delta from previous displayed frame: 0.000103038 seconds]
        [Time since reference or first frame: 3.329107210 seconds]
        Frame Number: 7
        Frame Length: 534 bytes (4272 bits)
        Capture Length: 534 bytes (4272 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:icmp:data]
    Ethernet II, Src: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa), Dst: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
        Destination: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 520
        Identification: 0x3587 (13703)
        Flags: 0x00
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..0. .... = More fragments: Not set
        ...0 0101 1100 1000 = Fragment Offset: 1480
        Time to Live: 63
        Protocol: ICMP (1)
        Header Checksum: 0x2cb2 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.1.2
        Destination Address: 10.0.2.2
        [2 IPv4 Fragments (1980 bytes): #6(1480), #7(500)]
            [Frame: 6, payload: 0-1479 (1480 bytes)]
            [Frame: 7, payload: 1480-1979 (500 bytes)]
            [Fragment count: 2]
            [Reassembled IPv4 length: 1980]
            [Reassembled IPv4 data: 08001ca0001300028845196800000000be5b080000000000101112131415161718191a1b…]
    Internet Control Message Protocol
        Type: 8 (Echo (ping) request)
        Code: 0
        Checksum: 0x1ca0 [correct]
        [Checksum Status: Good]
        Identifier (BE): 19 (0x0013)
        Identifier (LE): 4864 (0x1300)
        Sequence Number (BE): 2 (0x0002)
        Sequence Number (LE): 512 (0x0200)
        Timestamp from icmp data: May  5, 2025 16:11:04.000000000 PDT
        [Timestamp from icmp data (relative): 0.548036770 seconds]
        Data (1964 bytes)

    Frame 8: 1514 bytes on wire (12112 bits), 1514 bytes captured (12112 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.548054817 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.548054817 seconds
        [Time delta from previous captured frame: 0.000018047 seconds]
        [Time delta from previous displayed frame: 0.000018047 seconds]
        [Time since reference or first frame: 3.329125257 seconds]
        Frame Number: 8
        Frame Length: 1514 bytes (12112 bits)
        Capture Length: 1514 bytes (12112 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:data]
    Ethernet II, Src: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26), Dst: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
        Destination: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.2.2, Dst: 10.0.1.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 1500
        Identification: 0xfb36 (64310)
        Flags: 0x20, More fragments
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..1. .... = More fragments: Set
        ...0 0000 0000 0000 = Fragment Offset: 0
        Time to Live: 64
        Protocol: ICMP (1)
        Header Checksum: 0x42e7 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.2.2
        Destination Address: 10.0.1.2
    Data (1480 bytes)

    Frame 9: 534 bytes on wire (4272 bits), 534 bytes captured (4272 bits) on interface eth2, id 0
        Interface id: 0 (eth2)
            Interface name: eth2
        Encapsulation type: Ethernet (1)
        Arrival Time: May  5, 2025 16:11:04.548057482 PDT
        [Time shift for this packet: 0.000000000 seconds]
        Epoch Time: 1746486664.548057482 seconds
        [Time delta from previous captured frame: 0.000002665 seconds]
        [Time delta from previous displayed frame: 0.000002665 seconds]
        [Time since reference or first frame: 3.329127922 seconds]
        Frame Number: 9
        Frame Length: 534 bytes (4272 bits)
        Capture Length: 534 bytes (4272 bits)
        [Frame is marked: False]
        [Frame is ignored: False]
        [Protocols in frame: eth:ethertype:ip:icmp:data]
    Ethernet II, Src: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26), Dst: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
        Destination: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            Address: aa:c1:ab:75:ba:fa (aa:c1:ab:75:ba:fa)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Source: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            Address: aa:c1:ab:7d:bb:26 (aa:c1:ab:7d:bb:26)
            .... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)
            .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
        Type: IPv4 (0x0800)
    Internet Protocol Version 4, Src: 10.0.2.2, Dst: 10.0.1.2
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
            0000 00.. = Differentiated Services Codepoint: Default (0)
            .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
        Total Length: 520
        Identification: 0xfb36 (64310)
        Flags: 0x00
            0... .... = Reserved bit: Not set
            .0.. .... = Don't fragment: Not set
            ..0. .... = More fragments: Not set
        ...0 0101 1100 1000 = Fragment Offset: 1480
        Time to Live: 64
        Protocol: ICMP (1)
        Header Checksum: 0x6602 [validation disabled]
        [Header checksum status: Unverified]
        Source Address: 10.0.2.2
        Destination Address: 10.0.1.2
        [2 IPv4 Fragments (1980 bytes): #8(1480), #9(500)]
            [Frame: 8, payload: 0-1479 (1480 bytes)]
            [Frame: 9, payload: 1480-1979 (500 bytes)]
            [Fragment count: 2]
            [Reassembled IPv4 length: 1980]
            [Reassembled IPv4 data: 000024a0001300028845196800000000be5b080000000000101112131415161718191a1b…]
    Internet Control Message Protocol
        Type: 0 (Echo (ping) reply)
        Code: 0
        Checksum: 0x24a0 [correct]
        [Checksum Status: Good]
        Identifier (BE): 19 (0x0013)
        Identifier (LE): 4864 (0x1300)
        Sequence Number (BE): 2 (0x0002)
        Sequence Number (LE): 512 (0x0200)
        [Request frame: 7]
        [Response time: 0.021 ms]
        Timestamp from icmp data: May  5, 2025 16:11:04.000000000 PDT
        [Timestamp from icmp data (relative): 0.548057482 seconds]
        Data (1964 bytes)
    ```
  </TabItem>
</Tabs>
#### Closer look to the ICMP messages
Using the tshark captures for 1 ping we can see we received 2 packets as per the following snipets (removed fileds that are not relevant):
```bash title="First fragment"
Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
    Identification: 0x3586 (13702)
    Flags: 0x20, More fragments
        0... .... = Reserved bit: Not set
        .0.. .... = Don't fragment: Not set
        ..1. .... = More fragments: Set
    ...0 0000 0000 0000 = Fragment Offset: 0
```
```bash title="Second fragment"
Internet Protocol Version 4, Src: 10.0.1.2, Dst: 10.0.2.2
    Identification: 0x3586 (13702)
    Flags: 0x00
        0... .... = Reserved bit: Not set
        .0.. .... = Don't fragment: Not set
        ..0. .... = More fragments: Not set
    ...0 0101 1100 1000 = Fragment Offset: 1480
    [2 IPv4 Fragments (1980 bytes): #2(1480), #3(500)]
        [Frame: 2, payload: 0-1479 (1480 bytes)]
        [Frame: 3, payload: 1480-1979 (500 bytes)]
        [Fragment count: 2]
        [Reassembled IPv4 length: 1980]
        [Reassembled IPv4 data: 080005a5001300018845196800000000d557080000000000101112131415161718191a1b…]
Internet Control Message Protocol
    Type: 8 (Echo (ping) request)
    Code: 0
    Checksum: 0x05a5 [correct]
    [Checksum Status: Good]
    Identifier (BE): 19 (0x0013)
    Identifier (LE): 4864 (0x1300)
    Sequence Number (BE): 1 (0x0001)
    Sequence Number (LE): 256 (0x0100)
    Timestamp from icmp data: May  5, 2025 16:11:04.000000000 PDT
    [Timestamp from icmp data (relative): 0.547352848 seconds]
    Data (1964 bytes)
```
The following are the fields to look for:
- **Identification**: For both packets it is set to the same value (0x3586) which means that they are part of the same packet.
- **Flags**: The first packet has the "More fragments" flag set to 1 which means that there are more fragments to come. The second packet has the "More fragments" flag set to 0 which means that this is the last fragment.
- **Fragment Offset**: The first packet has the fragment offset set to 0 which means that this is the first fragment. The second packet has the fragment offset set to 1480 which means that that 1480 bytes have already been transmitted.

:::note
Tshark shows the details about the fragments in the "Reassembled IPv4" section. That is calculated based on the "Identification" and "Fragment Offset" fields.
:::
## Path MTU discovery

Path MTU discovery is a technique used to determine the maximum transmission unit (MTU) of the path to the destination.

This can be done on 2 ways
### Using the MTU from the ICMP Packet Too Big message
The sender sets the DF (Don't Fragment) flag to 1 and sends a packet to the destination. If the packet is too large to be transmitted over the network, the router will send an ICMP Packet Too Big message back to the sender with the MTU of the path. The sender can then adjust the size of the packet to fit into the MTU of the path.

This option can be used if the network does not filter the ICMP messages.

### Adjust to a smaller MTU until the packet is transmitted

The sender sets the DF (Don't Fragment) flag to 1 and sends a packet to the destination. If the packet is too large to be transmitted over the network, the sender will reduce the size of the packet and try again until it is transmitted successfully.

This case is used when the network filters the ICMP messages so then if there is no response we assume that the packet is too large and we need to reduce the size of the packet.

### Example ICMP message too big
The followinfg is a ping from r1 to r3 that fails
```bash
r1#ping 10.0.2.2 size 2000 df-bit repeat 1
PING 10.0.2.2 (10.0.2.2) 1972(2000) bytes of data.
ping: local error: message too long, mtu=1500

--- 10.0.2.2 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
```
The packet is sent with the DF bit set to 1 so fragmentations is not allowed. The system itself responds with the message "message too long, mtu=1500" which means that the packet is too large to be transmitted over the network and the MTU of the path is 1500 bytes.
